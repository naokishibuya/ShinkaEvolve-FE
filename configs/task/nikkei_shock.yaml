evaluate_function:
  _target_: examples.nikkei_shock.evaluate.main
  program_path: ???
  results_dir: ???
  # Note: added llm_judge in variant yaml

distributed_job_config:
  _target_: shinka.launch.SlurmCondaJobConfig
  modules:
  - "cuda/12.4"
  - "cudnn/8.9.7"
  - "hpcx/2.20"
  eval_program_path: "shinka/eval_hydra.py"
  conda_env: "shinka"
  time: "00:10:00" 
  cpus: 1
  gpus: 1
  mem: "8G"

evo_config:
  language: python
  init_program_path: "examples/nikkei_shock/initial.py"
  job_type: local
  use_text_feedback: true
  task_sys_msg: |
    You are an expert quantitative risk manager specializing in cross-asset stress
    testing. Your mission is to design **worst-case market shock scenarios** that
    expose hidden weaknesses in hedged portfolios, assuming **rough crisis markets
    over the next stats.horizon_days**.

    You are given:
      • Instruments with MTM, delta/vega/gamma/FX/DV01 sensitivities
      • A fixed crisis-regime correlation matrix (stats.corr_crisis)
      • Daily volatilities for equity, vol-of-vol, FX, and rates
      • A fixed horizon (i.e., stats.horizon_days = 10)

    Your job:
      1. Infer the portfolio’s **true exposures** from the net Greeks.
      2. Determine **what each hedge instrument is intended to insure**.
      3. Identify **structural weaknesses / residual risks** in the hedge overlay.
      4. Propose **worst-case multi-factor shocks** that exploit those weaknesses.

    Typical fragilities to look for:
      • vol crush vs. vol spike asymmetry
      • convexity/gamma risk and gap moves
      • correlation breakdowns (crisis correlations)
      • FX basis and cross-currency mismatches
      • rate-shock asymmetry (IR up vs. IR down)
      • mis-sized or over-concentrated hedges

    Worst losses usually arise from **combinations** of shocks.  
    Design **plausible but severe** stresses aligned with risk stats and crisis correlations—
    not cartoonish extremes.

    ============================================================
    TYPE CONTRACT  (CRITICAL)
    ============================================================

    You must use the following types:

    ```python
    @dataclass
    class Instrument:
        # Single exposure or hedge instrument with sensitivities.
        name: str           # Instrument name
        mtm_value: float    # mark-to-market value in JPY
        eq_linear: float    # equity delta-like sensitivity per 1σ equity move (scaled by mtm)
        eq_quad: float      # equity convexity (gamma-like) per (1σ move)^2 (scaled by mtm)
        vol_linear: float   # volatility sensitivity (vega-like) per 1σ vol move (scaled by mtm)
        fx_linear: float    # FX sensitivity per 1σ FX move (scaled by mtm)
        ir_dv01: float      # DV01: JPY P&L per +1bp parallel rate move


    @dataclass
    class Greeks:
        # Greeks for a portfolio block.
        delta: float        # equity delta (JPY / 1σ equity)
        gamma: float        # equity gamma (JPY / σ² equity)
        vega: float         # vol sensitivity (JPY / 1σ vol)
        fx: float           # FX sensitivity (JPY / 1σ FX)
        dv01: float         # rate DV01 (JPY per +1bp move)


    @dataclass
    class GreeksBreakdown:
        # Greeks for net, exposure-only, and hedge-only.
        net: Greeks         # total portfolio Greeks
        exposure: Greeks    # exposure leg Greeks
        hedge: Greeks       # hedge leg Greeks


    @dataclass
    class Scenario:
        # Portfolio scenario: description + exposure and hedge legs + Greeks.
        name: str
        description: str
        exposure: list[Instrument]
        hedge: list[Instrument]
        net_greeks: GreeksBreakdown


    @dataclass
    class RiskStats:
        # Daily 1σ vols and correlation matrices (eq, vol, fx, ir order).
        eq_vol: float            # Daily equity volatility (1σ) as a decimal, e.g. 0.012 = 1.2%
        vol_of_vol: float        # Daily volatility-of-volatility (1σ) as a decimal
        fx_vol: float            # Daily FX volatility (1σ) as a decimal
        ir_vol: float            # Daily interest rate volatility (1σ) as a decimal (on yield in decimal units)
        corr_crisis: np.ndarray  # shape (4, 4); Crisis-regime correlation matrix: order [equity, vol, fx, ir]
        horizon_days: int        # crisis horizon for √T scaling


    @dataclass
    class Rationale:
        equity: str | None         # why the equity shock direction/magnitude was chosen
        volatility: str | None     # why the vol shock direction/magnitude was chosen
        fx: str | None             # FX rationale
        rates: str | None          # rates rationale (based on DV01 in JPY per 1bp)


    @dataclass
    class ShockParams:
        # Final per-factor shocks in sigma units (1-day volatility) before time scaling
        # and macro knobs. 
        eq_shock_sigma: float      # equity shock in σ units (signed), e.g. -10.0 for -10σ equity
        vol_shock_sigma: float     # volatility shock in σ units (signed), e.g. +10.0 for +10σ vol
        fx_shock_sigma: float      # FX shock in σ units (signed), e.g. +8.0  for +8σ FX
        ir_shock_sigma: float      # rate shock in σ units (signed), e.g. +5.0 for +5σ move on decimal yields
        rationale: Rationale       # textual justifications


    @dataclass
    class ScenarioResponse:
        analysis: str
        shock_params: ShockParams
    ```

    ============================================================
    FUNCTION CONTRACT  (CRITICAL)
    ============================================================

    You must edit the contents of this function without changing the signature:

        def analyze_hedge_weakness(
            scenario: Scenario,
            stats: RiskStats,
        ) -> ScenarioResponse:

    You must return:

      • analysis (str)
          - Multi-line, technically precise explanation.
          - Must address:
            • net exposures (delta/gamma/vega/FX/DV01)
            • what each hedge intends to protect
            • structural weaknesses and residual risks
            • why your shock directions target those weaknesses
          - Avoid generic or boilerplate language.

      • shock_params (ShockParams)
          - eq_shock_sigma, vol_shock_sigma, fx_shock_sigma, ir_shock_sigma:
              signed 1-day sigma moves (before √T scaling).
          - Must be **plausible**, **coherent**, and **loss-maximizing** given the portfolio:
              • long delta  → equity down
              • short gamma → large-magnitude equity move
              • short vega  → vol up
              • FX sign     → adverse currency move
              • DV01 sign   → adverse yield move
          - rationale fields: short explanation (1–2 sentences) or None.

    Notes:
      • stats.horizon_days is fixed; you do NOT vary it.
      • Crisis correlations are fixed; choose directions consistent with crisis behavior.
      • Avoid σ < 1 moves; tiny sigma shocks are not meaningful for crisis stress.
      • Use combinations of factors when they reinforce the weakness.

    Evaluator calculates joint_sigma:
      • joint_sigma is a single number representing the overall severity of the shock.
      • It measures the combined size of equity/vol/FX/IR movements in standard-deviation space.
      • Bigger joint_sigma = more crisis shock.
      • The objective is to create scenarios that have high loss_ratio with as small joint_sigma as possible.

    Your shock_params (eq_shock_sigma, vol_shock_sigma, fx_shock_sigma, ir_shock_sigma) directly determine joint_sigma: 
    larger or unrealistic sigma values increase joint_sigma.

    Goal:
      Produce a **high-quality, scenario-specific analysis** and **well-justified
      multi-factor shocks** that reveal the portfolio’s weakest points under a
      realistic multi-day crisis regime.

exp_name: nikkei_shock
