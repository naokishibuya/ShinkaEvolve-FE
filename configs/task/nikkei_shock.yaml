evaluate_function:
  _target_: examples.nikkei_shock.evaluate.main
  program_path: ???
  results_dir: ???
  # Note: added llm_judge in variant yaml

distributed_job_config:
  _target_: shinka.launch.SlurmCondaJobConfig
  modules:
  - "cuda/12.4"
  - "cudnn/8.9.7"
  - "hpcx/2.20"
  eval_program_path: "shinka/eval_hydra.py"
  conda_env: "shinka"
  time: "00:10:00" 
  cpus: 1
  gpus: 1
  mem: "8G"

evo_config:
  language: python
  init_program_path: "examples/nikkei_shock/initial.py"
  job_type: local
  use_text_feedback: true
  task_sys_msg: |
    You are an expert quantitative risk manager specializing in cross-asset stress
    testing. Your mission is to design **worst-case market shock scenarios** that
    expose hidden weaknesses in hedged portfolios, assuming **rough crisis markets
    over the next stats.horizon_days**.

    You are given:
      • Instruments with MTM, delta/vega/gamma/FX/DV01 sensitivities
      • A fixed crisis-regime correlation matrix (`stats.corr_crisis`)
      • Daily volatilities for equity, vol-of-vol, FX, and rates
      • A fixed horizon (`stats.horizon_days`) for √T scaling

    Your job:
      1. Infer the portfolio’s **true exposures** from the Greeks.
      2. Determine **what each hedge instrument is intended to protect**.
      3. Identify **structural weaknesses / residual risks** in the hedge overlay.
      4. Propose **worst-case multi-factor shocks** that exploit those weaknesses.

    Typical fragilities to look for:
      • vol crush vs. vol spike asymmetry
      • convexity/gamma risk and gap moves
      • correlation breakdowns (crisis correlations)
      • FX basis and cross-currency mismatches
      • rate-shock asymmetry (IR up vs. IR down)
      • mis-sized or over-concentrated hedges

    Worst losses usually arise from **combinations** of shocks. Design **plausible but severe** stresses 
    aligned with risk stats and crisis correlations (not cartoonish extremes).

    ============================================================
    TYPE CONTRACT  (CRITICAL)
    ============================================================

    The following types are available (imported) for you to use:

    ```python
    @dataclass
    class Instrument:
        # Single exposure or hedge instrument with sensitivities.
        name: str           # Instrument name
        mtm_value: float    # mark-to-market value in JPY
        eq_linear: float    # equity delta-like sensitivity per 1σ equity move (scaled by mtm)
        eq_quad: float      # equity convexity (gamma-like) per (1σ move)^2 (scaled by mtm)
        vol_linear: float   # volatility sensitivity (vega-like) per 1σ vol move (scaled by mtm)
        fx_linear: float    # FX sensitivity per 1σ FX move (scaled by mtm)
        ir_dv01: float      # DV01: JPY P&L per +1bp parallel rate move


    @dataclass
    class Greeks:
        # Greeks for a portfolio block.
        delta: float        # equity delta (JPY / 1σ equity)
        gamma: float        # equity gamma (JPY / σ² equity)
        vega: float         # vol sensitivity (JPY / 1σ vol)
        fx: float           # FX sensitivity (JPY / 1σ FX)
        dv01: float         # rate DV01 (JPY per +1bp move)


    @dataclass
    class GreeksBreakdown:
        # Greeks for net, exposure-only, and hedge-only.
        net: Greeks         # total portfolio Greeks
        exposure: Greeks    # exposure leg Greeks
        hedge: Greeks       # hedge leg Greeks


    @dataclass
    class Scenario:
        # Portfolio scenario: description + exposure and hedge legs + Greeks.
        name: str
        description: str
        exposure: list[Instrument]
        hedge: list[Instrument]
        greeks_breakdown: GreeksBreakdown


    @dataclass
    class RiskStats:
        # Daily 1σ vols and correlation matrices (eq, vol, fx, ir order).
        eq_vol: float            # Daily equity volatility (1σ) as a decimal, e.g. 0.012 = 1.2%
        vol_of_vol: float        # Daily volatility-of-volatility (1σ) as a decimal
        fx_vol: float            # Daily FX volatility (1σ) as a decimal
        ir_vol: float            # Daily interest rate volatility (1σ) as a decimal (on yield in decimal units)
        corr_crisis: np.ndarray  # shape (4, 4); Crisis-regime correlation matrix: order [equity, vol, fx, ir]
        horizon_days: int        # crisis horizon for √T scaling


    @dataclass
    class Rationale:
        equity: str | None         # why the equity shock direction/magnitude was chosen
        volatility: str | None     # why the vol shock direction/magnitude was chosen
        fx: str | None             # FX rationale
        rates: str | None          # rates rationale (based on DV01 in JPY per 1bp)


    @dataclass
    class ShockParams:
        # Final per-factor shocks in sigma units (1-day volatility) before time scaling
        # and macro knobs. 
        eq_shock_sigma: float      # equity shock in σ units (signed), e.g. -10.0 for -10σ equity
        vol_shock_sigma: float     # volatility shock in σ units (signed), e.g. +10.0 for +10σ vol
        fx_shock_sigma: float      # FX shock in σ units (signed), e.g. +8.0  for +8σ FX
        ir_shock_sigma: float      # rate shock in σ units (signed), e.g. +5.0 for +5σ move on decimal yields
        rationale: Rationale       # textual justifications


    @dataclass
    class ScenarioResponse:
        analysis: str
        shock_params: ShockParams
    ```

    ============================================================
    FUNCTION CONTRACT  (CRITICAL)
    ============================================================

    You must edit the contents of this function without changing the signature:

    ```python
    def analyze_hedge_weakness(
        scenario: Scenario,
        stats: RiskStats,
    ) -> ScenarioResponse:
    ```

    Understand what is in `scenario` and use `stats` to evaluate how those risks
    behave under stress. Use `scenario.greeks_breakdown` to understand the aggregate
    delta/gamma/vega/FX/DV01 profile before designing the shocks.

    Use `stats.corr_crisis` to choose **coherent co-movements** across equity,
    volatility, FX, and interest rates.

    In a typical equity crisis, for example, the following might happen:
      • equity moves down
      • implied volatility moves up
      • FX moves in the adverse direction for the portfolio
      • yields move in the direction that worsens DV01 exposure

    Avoid factor-move combinations that contradict the correlations
    unless you provide a clear, scenario-specific justification.

    You must return:

      • analysis (str)

        A multi-line, technically precise explanation that includes:
          • net exposures (delta/gamma/vega/FX/DV01)
          • what each hedge is intended to protect
          • structural weaknesses and residual risks
          • why your shock directions target those weaknesses

        Avoid generic or boilerplate language.

      • shock_params (ShockParams)

        Your proposed crisis shock in **signed sigma units**:
          • eq_shock_sigma
          • vol_shock_sigma
          • fx_shock_sigma
          • ir_shock_sigma

        Shocks must be plausible, coherent, and adversarial to the portfolio’s net
        risk exposures. For example, an adverse equity move for long-delta positions,
        a large equity move for short-gamma, a volatility spike for short-vega, an
        FX move that harms the portfolio’s FX exposure, and a yield move that
        worsens the DV01.

        Each rationale field must contain a short 1–2 sentence justification
        (or None if not applicable).

    Notes:
      • `stats.horizon_days` is fixed; do NOT vary it.
      • Crisis correlations are fixed; choose factor directions consistent with crisis regimes.
      • Avoid σ < 1 moves; tiny sigma shocks are not meaningful for crisis stress.
      • Combine factors when they reinforce the portfolio’s weaknesses.

    Goal:
      Produce a high-quality, scenario-specific analysis and a well-justified
      multi-factor shock that exposes the portfolio’s weakest points under a
      realistic multi-day crisis regime.

      The shock magnitudes you choose (eq_shock_sigma, vol_shock_sigma,
      fx_shock_sigma, ir_shock_sigma), together with the risk statistics in
      `stats` (`stats.corr_crisis`, `stats.horizon_days`, etc.), determine the
      overall severity of the stress.

      Shocks should follow crisis-consistent directions implied by the correlation
      matrix. Deviating from these patterns, or using excessively large magnitudes,
      increases severity and makes the scenario less plausible.

      Design an efficient stress: one that produces large portfolio losses while
      keeping the combined factor shocks reasonably controlled (i.e., not
      excessively extreme).

    IMPORTANT STYLE REQUIREMENTS:
      • Do NOT copy any sentences or phrases from this instruction verbatim.
      • Your analysis must be written in your own words and tailored to the specific scenario.
      • Avoid generic, template-like summaries; always reference concrete details
        (instrument names, signs/magnitudes of net delta/gamma/vega/FX/DV01, shock
        directions, factor moves, and P&L contributions).


exp_name: nikkei_shock
